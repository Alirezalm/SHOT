/*
 * TaskCheckDualSolutionCandidates.cpp
 *
 *  Created on: Nov 22, 2015
 *      Author: alundell
 */

#include <TaskCheckDualSolutionCandidates.h>

TaskCheckDualSolutionCandidates::TaskCheckDualSolutionCandidates()
{
	
	
}

TaskCheckDualSolutionCandidates::~TaskCheckDualSolutionCandidates()
{
	// TODO Auto-generated destructor stub
}

void TaskCheckDualSolutionCandidates::run()
{
	bool isMinimization = ProcessInfo::getInstance().originalProblem->isTypeOfObjectiveMinimize();

	double currDualBound = ProcessInfo::getInstance().getDualBound();
	double currPrimalBound = ProcessInfo::getInstance().getPrimalBound();

	for (auto C : ProcessInfo::getInstance().dualSolutionCandidates)
	{

		if ((isMinimization && (C.objValue > currDualBound && C.objValue <= currPrimalBound))
				|| (!isMinimization && (C.objValue < currDualBound && C.objValue >= currPrimalBound)))
		{
			// New dual solution
			ProcessInfo::getInstance().currentObjectiveBounds.first = C.objValue;
			currDualBound = C.objValue;
			ProcessInfo::getInstance().iterLastDualBoundUpdate = ProcessInfo::getInstance().getCurrentIteration()->iterationNumber;
			ProcessInfo::getInstance().timeLastDualBoundUpdate = ProcessInfo::getInstance().getElapsedTime("Total");

			// If the solution is MILP feasible we only have a bound, no variable solutions
			if (C.sourceType != E_DualSolutionSource::MILPSolutionFeasible)
			{
				ProcessInfo::getInstance().addDualSolution(C);
			}

			std::string sourceDesc;

			switch (C.sourceType)
			{
				/*case E_DualSolutionSource::Linesearch:
				 sourceDesc = "line search";
				 break;*/
				case E_DualSolutionSource::LPSolution:
					sourceDesc = "LP solution";
					break;
				case E_DualSolutionSource::MILPSolutionOptimal:
					sourceDesc = "MILP solution";
					break;
				case E_DualSolutionSource::MILPSolutionFeasible:
					sourceDesc = "MILP solution bound";
					break;
				case E_DualSolutionSource::ObjectiveConstraint:
					sourceDesc = "Obj. constr. linesearch";
					break;
				default:
					break;
			}

			auto tmpLine = boost::format("     New dual bound %1% (%2%) ") % C.objValue % sourceDesc;

			ProcessInfo::getInstance().outputInfo(tmpLine.str());

		}
	}

	ProcessInfo::getInstance().dualSolutionCandidates.clear();
}

std::string TaskCheckDualSolutionCandidates::getType()
{
	std::string type = typeid(this).name();
	return (type);

}
